#!/usr/local/bin/perl
# -*- perl -*-

# Copyright (c) 2013
# Author: Jeff Weisberg <jaw @ tcp4me.com>
# Created: 2013-Mar-28 21:15 (EDT)
# Function: 
#
# $Id$

use strict;

my $DIR = "/home/athena/src/font/ucs";
my $file = shift @ARGV;

my $START = 32;
my $LAST  = 146;

(my $fontname = "ucs_$file") =~ s/\..*//;

open(F, "$DIR/$file") || die "cannot open $file: $!\n";

my %CHARNAME;
while(<DATA>){
    s/\s+#.*//;
    my($c, $name) = /^(\S+)\s+(.*)/;
    $CHARNAME{$c} = $name;
}


my($bbx, $bby, $ox, $oy);
my $cchar;
my @bitmap;
my %font;

print "\n// file: $DIR/$file\n";

while(<F>){
    chop;
    my($k, $v) = split /\s+/, $_, 2;

    if( $k eq 'FONT' ){ print "// font: $v\n"; next; }
    if( $k eq 'FONTBOUNDINGBOX' ){
        ($bbx, $bby, $ox, $oy) = split /\s+/, $v;
        next;
    }
    if( $k eq 'STARTCHAR' ){
        $cchar = $v;
        next;
    }
    if( $k eq 'BITMAP' ){
        while(<F>){
            chop;
            last if /ENDCHAR/;
            push @bitmap, hex($_);
        }
        $font{ $cchar } = [@bitmap];
        # print "$cchar => @bitmap\n";
        @bitmap = ();
        $cchar  = '';
    }
}

my $type = 'unsigned char';
$type   = 'unsigned short' if $bby > 8;
$type   = 'unsigned long'  if $bby > 16;

my $xbits = 8;
$xbits = 16 if $bbx > 8;
$xbits = 32 if $bbx > 16;

print <<EOH;

#define font_${fontname}_height $bby
#define font_${fontname}_width  $bbx
#define font_${fontname}_start  $START
#define font_${fontname}_last   $LAST
#define font_${fontname}_size	sizeof($type)

static const $type font_${fontname}_data[] = {
EOH
;

# print join(' ', keys %font), "\n";

for my $n ($START .. $LAST){
    mkglyph( $n );
}

print "};\n";
exit;

################################################################

# rotate pixels
sub mkglyph {
    my $n = shift;

    my $c    = chr($n);
    my $name = $CHARNAME{$c} || $CHARNAME{"u+$n"} || $c;
    my $b = $font{$name} || [];

    print "\t";
    for my $x (0 .. $bbx-1){
        my $line = 0;
        for my $y (0 .. $bby-1){
            my $p = ($b->[$y] & (1<<($xbits-$x-1))) ? 1 : 0;
            $line |= $p << $y;
        }
        printf "0x%x, ", $line;
    }

    print "\t// $n\t$name\n";
}

################################################################
__END__
  space
! exclam
" quotedbl
# numbersign
$ dollar
% percent
& ampersand
' quotesingle
( parenleft
) parenright
* asterisk
+ plus
, comma
- hyphen
. period
/ slash
0 zero
1 one
2 two
3 three
4 four
5 five
6 six
7 seven
8 eight
9 nine
: colon
; semicolon
< less
= equal
> greater
? question
@ at
[ bracketleft
\ backslash
] bracketright
^ asciicircum
_ underscore
` grave
{ braceleft
| bar
} braceright
~ asciitilde
u+128	arrowleft
u+129	arrowup
u+130	arrowright
u+131	arrowdown
u+132	arrowupdn
u+133	arrowboth
u+134	uni2196		# NW arrow
u+135	uni2197		# NE arrow
u+136	uni2198		# SE arrow
u+137	uni2199		# SW arrow
u+138	uni21B0		# up+left
u+139	uni21B1		# up+right
u+140	uni21B6		# up+left round
u+141	uni21B7		# up+right round
u+142	uni21BA		# ccw arrow
u+143	uni21BB		# cw arrow
u+144	smileface
u+145	uni2639		# frown
u+146	uni2620		# skull+crossbones
